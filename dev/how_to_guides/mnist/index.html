<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>How to Conformalize a Deep Image Classifier Â· ConformalPrediction.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://pat-alt.github.io/ConformalPrediction.jl/how_to_guides/mnist/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ConformalPrediction.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">ğŸ  Home</a></li><li><span class="tocitem">ğŸ«£ Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/">Overview</a></li><li><a class="tocitem" href="../../tutorials/classification/">Classification</a></li><li><a class="tocitem" href="../../tutorials/regression/">Regression</a></li><li><a class="tocitem" href="../../tutorials/plotting/">Visualizations</a></li></ul></li><li><span class="tocitem">ğŸ«¡ How-To Guides</span><ul><li><a class="tocitem" href="../">Overview</a></li><li class="is-active"><a class="tocitem" href>How to Conformalize a Deep Image Classifier</a><ul class="internal"><li><a class="tocitem" href="#The-Task-at-Hand"><span>The Task at Hand</span></a></li><li><a class="tocitem" href="#Building-the-Network"><span>Building the Network</span></a></li><li><a class="tocitem" href="#Conformalizing-the-Network"><span>Conformalizing the Network</span></a></li><li><a class="tocitem" href="#Results"><span>Results</span></a></li><li><a class="tocitem" href="#Evaluation"><span>Evaluation</span></a></li><li class="toplevel"><a class="tocitem" href="#References"><span>References</span></a></li></ul></li></ul></li><li><span class="tocitem">ğŸ¤“ Explanation</span><ul><li><a class="tocitem" href="../../explanation/">Overview</a></li><li><a class="tocitem" href="../../explanation/architecture/">Package Architecture</a></li></ul></li><li><a class="tocitem" href="../../_reference/">ğŸ§ Reference</a></li><li><a class="tocitem" href="../../contribute/">ğŸ›  Contribute</a></li><li><a class="tocitem" href="../../faq/">â“ FAQ</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">ğŸ«¡ How-To Guides</a></li><li class="is-active"><a href>How to Conformalize a Deep Image Classifier</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>How to Conformalize a Deep Image Classifier</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/pat-alt/ConformalPrediction.jl/blob/main/docs/src/how_to_guides/mnist.md#" title="Edit on GitHub"><span class="docs-icon fab">ï‚›</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="How-to-Conformalize-a-Deep-Image-Classifier"><a class="docs-heading-anchor" href="#How-to-Conformalize-a-Deep-Image-Classifier">How to Conformalize a Deep Image Classifier</a><a id="How-to-Conformalize-a-Deep-Image-Classifier-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-Conformalize-a-Deep-Image-Classifier" title="Permalink"></a></h1><p>Deep Learning is popular and â€” for some tasks like image classification â€” remarkably powerful. But it is also well-known that Deep Neural Networks (DNN) can be unstable (Goodfellow, Shlens, and Szegedy 2014) and poorly calibrated. Conformal Prediction can be used to mitigate these pitfalls. This how-to guide demonstrates how you can build an image classifier in <code>Flux.jl</code> and conformalize its predictions. For a formal treatment see A. Angelopoulos et al. (2022).</p><h2 id="The-Task-at-Hand"><a class="docs-heading-anchor" href="#The-Task-at-Hand">The Task at Hand</a><a id="The-Task-at-Hand-1"></a><a class="docs-heading-anchor-permalink" href="#The-Task-at-Hand" title="Permalink"></a></h2><p>The task at hand is to predict the labels of handwritten images of digits using the famous MNIST dataset (LeCun 1998). Importing this popular machine learning dataset in Julia is made remarkably easy through <code>MLDatasets.jl</code>:</p><pre><code class="language-julia hljs">using MLDatasets
N = 1000
Xraw, yraw = MNIST(split=:train)[:]
Xraw = Xraw[:,:,1:N]
yraw = yraw[1:N]</code></pre><p>The chart below shows a few random samples from the training data:</p><pre><code class="language-julia hljs">using MLJ
using Images
X = map(x -&gt; convert2image(MNIST, x), eachslice(Xraw, dims=3))
y = coerce(yraw, Multiclass)

n_samples = 10
mosaic(rand(X, n_samples)..., ncol=n_samples)</code></pre><p><img src="../mnist_files/figure-commonmark/fig-samples-output-1.png" alt="FigureÂ 1: Random samples from the MNIST dataset."/></p><h2 id="Building-the-Network"><a class="docs-heading-anchor" href="#Building-the-Network">Building the Network</a><a id="Building-the-Network-1"></a><a class="docs-heading-anchor-permalink" href="#Building-the-Network" title="Permalink"></a></h2><p>To model the mapping from image inputs to labels will rely on a simple Multi-Layer Perceptron (MLP). A great Julia library for Deep Learning is <code>Flux.jl</code>. But wait â€¦ doesnâ€™t <code>ConformalPrediction.jl</code> work with models trained in <code>MLJ.jl</code>? Thatâ€™s right, but fortunately there exists a <code>Flux.jl</code> interface to <code>MLJ.jl</code>, namely <code>MLJFlux.jl</code>. The interface is still in its early stages, but already very powerful and easily accessible for anyone (like myself) who is used to building Neural Networks in <code>Flux.jl</code>.</p><p>In <code>Flux.jl</code>, you could build an MLP for this task as follows,</p><pre><code class="language-julia hljs">using Flux

mlp = Chain(
    Flux.flatten,
    Dense(prod((28,28)), 32, relu),
    Dense(32, 10)
)</code></pre><p>where <code>(28,28)</code> is just the input dimension (28x28 pixel images). Since we have ten digits, our output dimension is ten.[1]</p><p>We can do the exact same thing in <code>MLJFlux.jl</code> as follows,</p><pre><code class="language-julia hljs">using MLJFlux

builder = MLJFlux.@builder Chain(
    Flux.flatten,
    Dense(prod(n_in), 32, relu),
    Dense(32, n_out)
)</code></pre><p>where here we rely on the <code>@builder</code> macro to make the transition from <code>Flux.jl</code> to <code>MLJ.jl</code> as seamless as possible. Finally, <code>MLJFlux.jl</code> already comes with a number of helper functions to define plain-vanilla networks. In this case, we will use the <code>ImageClassifier</code> with our custom builder and cross-entropy loss:</p><pre><code class="language-julia hljs">ImageClassifier = @load ImageClassifier
clf = ImageClassifier(
    builder=builder,
    epochs=10,
    loss=Flux.crossentropy
)</code></pre><p>The generated instance <code>clf</code> is a model (in the <code>MLJ.jl</code> sense) so from this point on we can rely on standard <code>MLJ.jl</code> workflows. For example, we can wrap our model in data to create a machine and then evaluate it on a holdout set as follows:</p><pre><code class="language-julia hljs">mach = machine(clf, X, y)

evaluate!(
    mach,
    resampling=Holdout(rng=123, fraction_train=0.8),
    operation=predict_mode,
    measure=[accuracy]
)</code></pre><p>The accuracy of our very simple model is not amazing, but good enough for the purpose of this tutorial. For each image, our MLP returns a softmax output for each possible digit: 0,1,2,3,â€¦,9. Since each individual softmax output is valued between zero and one, <em>y</em><em>(<em>k</em>)â€„âˆˆâ€„(0,1), this is commonly interpreted as a probability: <em>y</em></em>(<em>k</em>)â€„â‰”â€„<em>p</em>(<em>y</em>=<em>k</em>|<em>X</em>). Edge cases â€“ that is values close to either zero or one â€“ indicate high predictive certainty. But this is only a heuristic notion of predictive uncertainty (A. N. Angelopoulos and Bates 2021). Next, we will turn this heuristic notion of uncertainty into a rigorous one using Conformal Prediction.</p><h2 id="Conformalizing-the-Network"><a class="docs-heading-anchor" href="#Conformalizing-the-Network">Conformalizing the Network</a><a id="Conformalizing-the-Network-1"></a><a class="docs-heading-anchor-permalink" href="#Conformalizing-the-Network" title="Permalink"></a></h2><p>Since <code>clf</code> is a model, it is also compatible with our package: <code>ConformalPrediction.jl</code>. To conformalize our MLP, we therefore only need to call <code>conformal_model(clf)</code>. Since the generated instance <code>conf_model</code> is also just a model, we can still rely on standard <code>MLJ.jl</code> workflows. Below we first wrap it in data and then fit it. Aaaand â€¦ weâ€™re done! Letâ€™s look at the results in the next section.</p><pre><code class="language-julia hljs">using ConformalPrediction
conf_model = conformal_model(clf; method=:simple_inductive)
mach = machine(conf_model, X, y)
fit!(mach)</code></pre><h2 id="Results"><a class="docs-heading-anchor" href="#Results">Results</a><a id="Results-1"></a><a class="docs-heading-anchor-permalink" href="#Results" title="Permalink"></a></h2><p>The charts below present the results. The first row displays highly certain predictions, now defined in the rigorous sense of Conformal Prediction: in each case, the conformal set (just beneath the image) includes only one label.</p><p>The following two rows display increasingly uncertain predictions of set size two and three, respectively. They demonstrate that CP is well equipped to deal with samples characterized by high aleatoric uncertainty: digits four (4), seven (7) and nine (9) share certain similarities. So do digits five (5) and six (6) as well as three (3) and eight (8). These may be hard to distinguish from each other even after seeing many examples (and even for a human). It is therefore unsurprising to see that these digits often end up together in conformal sets.</p><p><img src="../mnist_files/figure-commonmark/fig-plots-output-1.svg" alt="FigureÂ 2: Plot 1"/></p><p><img src="../mnist_files/figure-commonmark/fig-plots-output-2.svg" alt="FigureÂ 3: Plot 2"/></p><p><img src="../mnist_files/figure-commonmark/fig-plots-output-3.svg" alt="FigureÂ 4: Plot 3"/></p><p>Conformalised predictions from an image classifier.</p><h2 id="Evaluation"><a class="docs-heading-anchor" href="#Evaluation">Evaluation</a><a id="Evaluation-1"></a><a class="docs-heading-anchor-permalink" href="#Evaluation" title="Permalink"></a></h2><p>As always, we can also evaluate our conformal model in terms of coverage (correctness) and size-stratified coverage (adaptiveness).</p><pre><code class="language-julia hljs">_eval = evaluate!(
    mach,
    resampling=Holdout(rng=123, fraction_train=0.8),
    operation=predict,
    measure=[emp_coverage, ssc]
)
display(_eval)
println(&quot;Empirical coverage: $(round(_eval.measurement[1], digits=3))&quot;)
println(&quot;SSC: $(round(_eval.measurement[2], digits=3))&quot;)</code></pre><pre><code class="nohighlight hljs">PerformanceEvaluation object with these fields:
  measure, operation, measurement, per_fold,
  per_observation, fitted_params_per_fold,
  report_per_fold, train_test_rows
Extract:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€
â”‚ measure                                                   â”‚ operation â”‚ meas â‹¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€
â”‚ emp_coverage (generic function with 1 method)             â”‚ predict   â”‚ 0.95 â‹¯
â”‚ size_stratified_coverage (generic function with 1 method) â”‚ predict   â”‚ 0.86 â‹¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€
                                                               2 columns omitted

Empirical coverage: 0.955
SSC: 0.867</code></pre><p>Unsurprisingly, we can attain higher adaptivity (SSC) when using adaptive prediction sets:</p><pre><code class="language-julia hljs">conf_model = conformal_model(clf; method=:adaptive_inductive)
mach = machine(conf_model, X, y)
fit!(mach)
_eval = evaluate!(
    mach,
    resampling=Holdout(rng=123, fraction_train=0.8),
    operation=predict,
    measure=[emp_coverage, ssc]
)
results[:adaptive_inductive] = mach
display(_eval)
println(&quot;Empirical coverage: $(round(_eval.measurement[1], digits=3))&quot;)
println(&quot;SSC: $(round(_eval.measurement[2], digits=3))&quot;)</code></pre><pre><code class="nohighlight hljs">PerformanceEvaluation object with these fields:
  measure, operation, measurement, per_fold,
  per_observation, fitted_params_per_fold,
  report_per_fold, train_test_rows
Extract:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€
â”‚ measure                                                   â”‚ operation â”‚ meas â‹¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€
â”‚ emp_coverage (generic function with 1 method)             â”‚ predict   â”‚ 0.99 â‹¯
â”‚ size_stratified_coverage (generic function with 1 method) â”‚ predict   â”‚ 0.96 â‹¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€
                                                               2 columns omitted

Empirical coverage: 0.995
SSC: 0.967</code></pre><p>We can also have a look at the resulting set size for both approaches:</p><pre><code class="language-julia hljs">plt_list = []
for (_mod, mach) in results
    push!(plt_list, bar(mach.model, mach.fitresult, X; title=String(_mod)))
end
plot(plt_list..., size=(800,300))</code></pre><p><img src="../mnist_files/figure-commonmark/fig-setsize-output-1.svg" alt="FigureÂ 5: Prediction interval width."/></p><h1 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h1><p>Angelopoulos, Anastasios N., and Stephen Bates. 2021. â€œA Gentle Introduction to Conformal Prediction and Distribution-Free Uncertainty Quantification.â€ <a href="https://arxiv.org/abs/2107.07511">https://arxiv.org/abs/2107.07511</a>.</p><p>Angelopoulos, Anastasios, Stephen Bates, Jitendra Malik, and Michael I. Jordan. 2022. â€œUncertainty Sets for Image Classifiers Using Conformal Prediction.â€ arXiv. <a href="http://arxiv.org/abs/2009.14193">http://arxiv.org/abs/2009.14193</a>.</p><p>Goodfellow, Ian J, Jonathon Shlens, and Christian Szegedy. 2014. â€œExplaining and Harnessing Adversarial Examples.â€ <a href="https://arxiv.org/abs/1412.6572">https://arxiv.org/abs/1412.6572</a>.</p><p>LeCun, Yann. 1998. â€œThe MNIST Database of Handwritten Digits.â€</p><p>[1] For a full tutorial on how to build an MNIST image classifier relying solely on <code>Flux.jl</code>, check out this <a href="https://fluxml.ai/Flux.jl/stable/tutorials/2021-01-26-mlp/">tutorial</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">Â« Overview</a><a class="docs-footer-nextpage" href="../../explanation/">Overview Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Monday 12 December 2022 08:21">Monday 12 December 2022</span>. Using Julia version 1.8.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
